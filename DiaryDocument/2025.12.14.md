# 2025.12.14 Development Log (LangChain + FastAPI Chat Companion)

## Local SD & Cloud Gemini (Banana nano) Dual-Path Integration

### Environment & Configuration
- **Local SD**: `SD_BASE_URL` (e.g., `http://host.docker.internal:7860`), `SD_MODEL` (optional), `SD_ENABLED=true/false`
- **Cloud Gemini**: `GEMINI_BASE_URL`, `GEMINI_API_KEY`, `GEMINI_MODEL`, `GEMINI_ENABLED=true/false`
- **Route Strategy**: `IMAGE_PROVIDER=local|cloud|auto` (auto tries local first, falls back to cloud)

### Backend Implementation (FastAPI)
- **New Services**:
    - `services/vision/sd_client.py`: Calls `/sdapi/v1/txt2img`, returns base64/PNG
    - `services/vision/gemini_client.py`: Calls Banana nano/Gemini API
- **Unified Interface**: `ImageGenerator` selects SD or Gemini based on `IMAGE_PROVIDER` with auto-fallback
- **Route**: `POST /api/v1/image` with `{ prompt, negative_prompt?, steps?, width?, height?, provider? }` → `{ image_base64, provider, trace_id }`
- **Health Check**: `GET /api/v1/image/health` returns provider availability

### Frontend Updates
- **API**: New `generateImage()` method calling `/api/v1/image`
- **UI**: Image generation area with loading state, error handling, and provider display
- **Config**: Uses existing `VITE_API_BASE_URL`/`VITE_API_KEY`

---

## Configuration & Verification

### Start WebUI with API
```bash
webui-user.bat --api --listen --port 7860
```
Verify: `curl http://localhost:7860/sdapi/v1/sd-models`

### Docker Health Check
```bash
curl -H "X-API-Key: qsnnb666" http://localhost:8000/api/v1/image/health
```

---

## Electron Build Fix

**Issue**: Missing symlink permissions during `electron:build`

**Solutions**:
1. **Enable Developer Mode**: Settings → Privacy & Security → Developer Options → turn on "Developer Mode", restart PowerShell
2. **Admin Retry with Cache Clear**:
     ```powershell
     Remove-Item "$env:LOCALAPPDATA\electron-builder\Cache\winCodeSign" -Recurse -Force -ErrorAction SilentlyContinue
     npm run electron:build
     ```

Output: `frontend\release\win-unpacked\Membot Desktop.exe`
