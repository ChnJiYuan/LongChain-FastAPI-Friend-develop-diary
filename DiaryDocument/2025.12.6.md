# 2025.12.6 Development Log (LangChain + FastAPI Chat Companion)
äº†è§£åˆ°å¤§æ¨¡å‹è®°å¿†ç›¸å…³å·¥å…·ï¼šMemori å°è¯•æœ‰æ— ä½¿ç”¨è¿›é¡¹ç›®ä¸­çš„å¯èƒ½æ€§
äº†è§£Milvus(æ”¯æŒå‘é‡æ£€ç´¢ç®—æ³•çš„å‘é‡æ•°æ®åº“)ï¼Œå°è¯•ä½¿ç”¨è¿›é¡¹ç›®çš„å¯èƒ½æ€§




å¯ä»¥ç®€å•ç†è§£æˆï¼š

> **Memori = ç»“æ„åŒ–ã€åƒâ€œäººç±»ç¬”è®°æœ¬â€çš„è®°å¿†**
> **Milvus = è¶…å¤§è§„æ¨¡ã€â€œæˆ‘ä»¥å‰è¯´è¿‡ç±»ä¼¼å•¥â€çš„å‘é‡è®°å¿†ä»“åº“**

ä¸‹é¢æˆ‘å¸®ä½ æŠŠè¿™ä¸¤ä¸ªä¸œè¥¿ã€Œæ‹¼åœ¨ä¸€èµ·ã€ï¼Œæ”¾è¿›ä½ ç°åœ¨çš„ **LangChain + FastAPI** é¡¹ç›®é‡Œã€‚

---

## 1. å…ˆå®šâ€œåˆ†å·¥â€ï¼šMemori åšä»€ä¹ˆï¼ŒMilvus åšä»€ä¹ˆï¼Ÿ

### ğŸ§  Memoriï¼šè´Ÿè´£â€œå…³é”®äº‹å®â€å’Œäººç‰©è®¾å®š

é€‚åˆå­˜çš„ä¸œè¥¿ï¼š

* ç”¨æˆ·çš„ **é•¿æœŸåå¥½**ï¼šå–œæ¬¢çš„æŠ¤è‚¤å“ã€æ¸¸æˆã€ä¸“ä¸šã€æœªæ¥è§„åˆ’
* ç”¨æˆ·çš„ **ç”Ÿæ´»äº‹ä»¶**ï¼šæœ€è¿‘å®ä¹ æƒ…å†µã€æ­£åœ¨åšçš„è¯¾ç¨‹é¡¹ç›®
* **äººæ ¼ç›¸å…³ä¿¡æ¯**ï¼šç”¨æˆ·å¸Œæœ› AI æ€ä¹ˆç§°å‘¼å¥¹ã€èŠå¤©é£æ ¼åå¥½
* ä»å›¾ç‰‡æˆ–å¯¹è¯é‡ŒæŠ½å‡ºæ¥çš„ **ç»“æ„åŒ–äº‹å®**ï¼š

  * â€œå¥¹æœ€è¿‘å› ä¸ºç—˜ç—˜åœ¨çœ‹çš®è‚¤ç§‘â€
  * â€œå¥¹åœ¨åš LangChain & FastAPI é¡¹ç›®ï¼Œç›®æ ‡æ˜¯é™ªä¼´å‹åŠ©æ‰‹â€

è¿™äº›ä¿¡æ¯æ¯”è¾ƒâ€œç²¾â€ï¼Œæ•°é‡ä¸ä¼šç‰¹åˆ«çˆ†ç‚¸ï¼Œä½†éå¸¸å…³é”®ï¼Œé€‚åˆç”¨ Memori çš„ç»“æ„åŒ–è®°å¿†ã€å®ä½“å…³ç³»ã€è·¨ä¼šè¯å›å¿†ã€‚

---

### ğŸ“š Milvusï¼šè´Ÿè´£â€œæµ·é‡è¯­æ–™â€çš„ç›¸ä¼¼åº¦æ£€ç´¢

é€‚åˆå­˜çš„ä¸œè¥¿ï¼š

* å¤§æ®µ **å†å²èŠå¤©è®°å½•**ï¼ˆåˆ‡æˆ chunkï¼‰
* ç”¨æˆ·ä¸Šä¼ çš„ **æ–‡æ¡£ã€ç¬”è®°ã€ä½œä¸šè¦æ±‚** çš„ embedding
* é¡¹ç›®ç›¸å…³çš„ **è¯´æ˜æ–‡æ¡£**ï¼ˆä½ ä»¥åå†™çš„ READMEã€API æ–‡æ¡£ï¼‰
* å›¾åƒçš„æ–‡æœ¬æè¿°ï¼ˆæ¯”å¦‚ CLIP / Vision æ¨¡å‹ç”Ÿæˆçš„ä¸€å¥ summaryï¼Œå†åš embeddingï¼‰

è¿™äº›ä¿¡æ¯ä½“é‡å¤§ã€ç²¾ç»†åº¦æ²¡é‚£ä¹ˆé«˜ï¼Œä½†éœ€è¦â€œç›¸ä¼¼åº¦æ£€ç´¢â€ï¼ŒMilvus å°±éå¸¸æ“…é•¿ï¼š**é«˜é€Ÿå‘é‡æ£€ç´¢ + å¤§è§„æ¨¡å­˜å‚¨**ã€‚

---

## 2. ä¸€ä¸ªè¯·æ±‚è¿›æ¥æ—¶ï¼Œæ€ä¹ˆåŒæ—¶ç”¨ä¸Š Memori å’Œ Milvusï¼Ÿ

ä»¥ä½ æœªæ¥çš„ API ä¸ºä¾‹ï¼š
`POST /chat` ä¼ å…¥ï¼š`user_id` + `message`ï¼ˆå¯ä»¥å¸¦å›¾ç‰‡ï¼‰ã€‚

**å¤„ç†æµç¨‹æ¨èè¿™æ ·ï¼š**

1. **æ¥æ”¶è¯·æ±‚**

   * FastAPI æ¥åˆ°ç”¨æˆ·è¾“å…¥ï¼ˆæ–‡å­— + å¯é€‰å›¾ç‰‡ï¼‰

2. **å†™å…¥è®°å¿†ï¼ˆåŒæ­¥å†™ï¼‰**

   * è°ƒç”¨ Memoriï¼šæŠ½å–äº‹å®ï¼Œä¿å­˜é•¿æœŸè®°å¿†
   * ç”Ÿæˆå‘é‡ embeddingï¼ˆç”¨ OpenAI æˆ–æœ¬åœ° embedding æ¨¡å‹ï¼‰
   * å‘ Milvus ä¸­ `insert` ä¸€æ¡ï¼š

     * `user_id, content, type="chat", timestamp, embedding`

3. **æ£€ç´¢è®°å¿†ï¼ˆè¯»ï¼‰**

   * ä» Memori æŸ¥è¯¢ï¼š

     * `get_profile(user_id)`
     * `get_recent_key_facts(user_id)`
   * ä» Milvus æ£€ç´¢ï¼š

     * ç”¨ `message` åš embeddingï¼Œåœ¨ç”¨æˆ·è‡ªå·±çš„åˆ†åŒºé‡Œ `search top-k`
     * æ‹¿åˆ°å’Œè¿™æ¬¡æœ€ç›¸å…³çš„å†å²å¯¹è¯ / æ–‡æ¡£ç‰‡æ®µ

4. **åˆå¹¶æˆä¸Šä¸‹æ–‡ï¼Œäº¤ç»™ LangChain / LLM**

   ä¼ª prompt æ¨¡æ¿ï¼š

   ```text
   [ç³»ç»ŸæŒ‡ä»¤ï¼šä½ æ˜¯ç”¨æˆ·çš„é•¿æœŸé™ªä¼´åŠ©æ‰‹ï¼Œäº†è§£å¥¹çš„èƒŒæ™¯å’Œå–œå¥½ã€‚]

   [ç”¨æˆ·çš„å…³é”®ä¿¡æ¯ï¼ˆæ¥è‡ª Memoriï¼‰]
   - â€¦

   [ä¸å½“å‰é—®é¢˜æœ€ç›¸å…³çš„å†å²ç‰‡æ®µï¼ˆæ¥è‡ª Milvusï¼‰]
   1. â€¦
   2. â€¦

   [å½“å‰ç”¨æˆ·æ¶ˆæ¯]
   {{ user_message }}
   ```

5. **LLM ç”Ÿæˆå›å¤ â†’ å†æ¬¡å†™å› Memori & Milvus**

---

## 3. ä»£ç å±‚é¢æ€ä¹ˆâ€œç»‘â€åœ¨ä¸€èµ·ï¼Ÿ

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ **FastAPI + Memori + Milvus + LangChain** ç»„åˆç¤ºä¾‹ï¼ˆPython ä¼ªä»£ç é£ï¼‰ï¼š

### 3.1 åˆå§‹åŒ–éƒ¨åˆ†

```python
from fastapi import FastAPI
from memori import Memori
from pymilvus import connections, Collection
from langchain_openai import ChatOpenAI, OpenAIEmbeddings
from langchain_community.vectorstores import Milvus as LC_Milvus

app = FastAPI()

# 1. Memori
memori = Memori(project_id="companion-assistant")

# 2. Milvus è¿æ¥
connections.connect("default", host="localhost", port="19530")
# è¿™é‡Œå‡è®¾ä½ å·²ç»ç”¨ pymilvus å»ºå¥½äº† collectionï¼ˆæ¯”å¦‚ name="chat_history"ï¼‰

embeddings = OpenAIEmbeddings()

vector_store = LC_Milvus(
    embedding_function=embeddings,
    collection_name="chat_history"
)

# 3. LLM
llm = ChatOpenAI(model="gpt-4.1")
```

---

### 3.2 å†™å…¥ï¼šæ”¶åˆ°ç”¨æˆ·æ¶ˆæ¯æ—¶

```python
def save_to_memori_and_milvus(user_id: str, message: str):
    # å†™å…¥ Memoriï¼ˆç”± Memori å†…éƒ¨è´Ÿè´£æŠ½å–äº‹å®ï¼‰
    memori.save(user_id, message)

    # ç”Ÿæˆ embeddingï¼ˆå¯ä»¥æ¢æˆæœ¬åœ°æ¨¡å‹ï¼‰
    embedding = embeddings.embed_query(message)

    # å†™å…¥ Milvusï¼ˆé€šè¿‡ LangChain å°è£…çš„ vector_storeï¼‰
    vector_store.add_texts(
        texts=[message],
        metadatas=[{"user_id": user_id}],
        ids=None
    )
```

---

### 3.3 æ£€ç´¢ï¼šåœ¨ç”Ÿæˆå›å¤å‰è·å–â€œè®°å¿†ä¸Šä¸‹æ–‡â€

```python
def retrieve_context(user_id: str, query: str):
    # 1. ä» Memori æ‹¿ç»“æ„åŒ–è®°å¿†
    profile = memori.query(user_id, "basic profile and long-term preferences")
    recent_facts = memori.query(user_id, "recent important events")

    memori_context = f"User profile:\n{profile}\n\nRecent facts:\n{recent_facts}\n"

    # 2. ä» Milvus æ£€ç´¢ç›¸ä¼¼å¯¹è¯ / æ–‡æ¡£
    retriever = vector_store.as_retriever(
        search_kwargs={"k": 5, "filter": {"user_id": user_id}}
    )
    docs = retriever.get_relevant_documents(query)
    milvus_chunks = "\n".join([d.page_content for d in docs])

    return memori_context, milvus_chunks
```

---

### 3.4 FastAPI èŠå¤©æ¥å£ç¤ºä¾‹

```python
from pydantic import BaseModel

class ChatRequest(BaseModel):
    user_id: str
    message: str

class ChatResponse(BaseModel):
    reply: str

@app.post("/chat", response_model=ChatResponse)
async def chat(req: ChatRequest):
    # 1. å…ˆæŠŠè¿™æ¡æ¶ˆæ¯å†™å…¥è®°å¿†
    save_to_memori_and_milvus(req.user_id, req.message)

    # 2. å†åŒæ—¶ä» Memori + Milvus æ‹¿ä¸Šä¸‹æ–‡
    memori_ctx, milvus_ctx = retrieve_context(req.user_id, req.message)

    # 3. ç»„è£… Prompt
    prompt = f"""
ä½ æ˜¯ä¸€ä¸ªé•¿æœŸé™ªä¼´ç”¨æˆ·çš„èŠå¤©åŠ©æ‰‹ï¼Œéå¸¸äº†è§£å¥¹çš„èƒŒæ™¯ã€ç”Ÿæ´»çŠ¶æ€å’Œæƒ…ç»ªã€‚

[å…³äºç”¨æˆ·çš„é•¿æœŸä¿¡æ¯ï¼ˆæ¥è‡ªç»“æ„åŒ– Memoriï¼‰]
{memori_ctx}

[ä¸å½“å‰å¯¹è¯æœ€ç›¸å…³çš„å†å²ç‰‡æ®µï¼ˆæ¥è‡ª Milvus å‘é‡æ£€ç´¢ï¼‰]
{milvus_ctx}

å½“å‰ç”¨æˆ·è¯´ï¼š
{req.message}

è¯·ç”¨è‡ªç„¶ã€æ¸©æŸ”ã€æœ‰â€œäººå‘³â€çš„ä¸­æ–‡å›å¤å¥¹ï¼Œé¿å…æœºæ¢°å›ç­”ã€‚
"""

    resp = llm.invoke(prompt)
    return ChatResponse(reply=resp.content)
```

---

## 4. å›¾ç‰‡æ€ä¹ˆä¸€èµ·â€œå–‚â€è¿› Memori + Milvusï¼Ÿ

ä½ åé¢è‚¯å®šä¼šåšï¼š**ç”¨æˆ·ä¸Šä¼ çš®è‚¤ç…§ç‰‡ / ç”Ÿæ´»ç…§ç‰‡** â†’ è®©åŠ©æ‰‹â€œçœ‹å›¾è¯´è¯ + è®°ä½â€ã€‚

ä¸€ä¸ªè‡ªç„¶çš„æµç¨‹æ˜¯ï¼š

1. FastAPI æ”¶åˆ°å›¾ç‰‡
2. Vision æ¨¡å‹ï¼ˆæ¯”å¦‚ OpenAI Vision / Gemini / æœ¬åœ° CLIPï¼‰ç”Ÿæˆæè¿°æ–‡å­—ï¼š

   * â€œå¥¹è„¸ä¸Š T åŒºæ²¹å…‰ï¼Œè„¸é¢Šæœ‰æ³›çº¢â€
   * â€œç…§ç‰‡ä¸­æ˜¯åœ¨ç”µè„‘å‰å­¦ä¹ ï¼Œå±å¹•ä¸Šæ˜¯ VSCode å’Œ FastAPI é¡¹ç›®â€
3. æŠŠè¿™æ®µæ–‡å­—ï¼š

   * ä½œä¸º **äº‹å®** å†™å…¥ Memoriï¼ˆå¦‚ â€œæœ€è¿‘çš®è‚¤çŠ¶å†µä¸å¥½â€ï¼‰
   * ä½œä¸º **æ–‡æœ¬å†…å®¹** åš embedding â†’ å­˜å…¥ Milvus

ä»¥åç”¨æˆ·é—®ï¼š

> â€œä½ è¿˜è®°å¾—æˆ‘ç—˜ç—˜é‚£é˜µå­å—ï¼Ÿâ€

* Milvusï¼šæ‰¾å‡ºé‚£å‡ æ¬¡å…³äºçš®è‚¤çš„å¯¹è¯ + å›¾åƒæè¿°
* Memoriï¼šè¡¥å……â€œé‚£æ®µæ—¶é—´å¥¹æƒ…ç»ªæœ‰ç‚¹ç´§å¼ ï¼Œå»çœ‹äº†çš®è‚¤ç§‘â€

åˆåœ¨ä¸€èµ·ï¼Œå›å¤å°±å¾ˆâ€œè´´å¿ƒâ€ã€‚

---

## 5. æ€»ç»“ä¸€å¥è¯æ–¹æ¡ˆ

> **Memori è´Ÿè´£â€œæˆ‘çŸ¥é“ä½ æ˜¯è°ã€ä½ æœ€è¿‘åœ¨ç»å†ä»€ä¹ˆâ€ï¼Œ
> Milvus è´Ÿè´£â€œä½ ä»¥å‰è·Ÿæˆ‘è¯´è¿‡ä»€ä¹ˆç›¸ä¼¼çš„é—®é¢˜å’Œä¸Šä¸‹æ–‡â€ï¼Œ
> ä¸¤è€…ä¸€èµ·æ¥åœ¨ FastAPI + LangChain å‰é¢ï¼Œç»™ LLM å‡†å¤‡å®Œæ•´çš„â€œè®°å¿† +åœºæ™¯â€ã€‚**

---

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¸®ä½ ï¼š

* ç›´æ¥ç»™å‡º **å®Œæ•´é¡¹ç›®ç›®å½•ç»“æ„**ï¼ˆbackend / frontend / memory / modelsï¼‰
* è®¾è®¡ä¸€ä¸ªã€ŒMemoryServiceã€ç±»ï¼Œå†…éƒ¨åŒæ—¶å°è£… Memori å’Œ Milvus
* å¸®ä½ å†™ä¸€ä¸ª **æœ€å°å¯è¿è¡Œçš„ demo**ï¼šæœ¬åœ°èµ· FastAPIï¼Œè¿ Milvusï¼Œè¿ OpenAIï¼Œä¸€æ¬¡å°±èƒ½è·‘é€šä¸€è½®å¯¹è¯

Added backend app package under backend/app with FastAPI factory (backend/app/main.py), env/logging/security config (backend/app/core/*.py), v1 routers (backend/app/api/v1/routes/chat.py, memory.py, admin.py, health.py), Pydantic models, and dependency wiring (backend/app/api/v1/deps.py).
Implemented memory stack placeholders: Memori client, Milvus client with in-memory fallback, orchestration service, and embedder stub (backend/app/services/memory/*.py). LLM routing for OpenAI/Ollama plus prompt builder and chat chain (backend/app/services/llm/*, backend/app/services/chains/chat_chain.py). Vision/tools/persistence helpers stubbed for future work.
Added basic tests and path setup (backend/app/tests/*, backend/app/tests/conftest.py), Dockerfile for backend (backend/Dockerfile), and new requirements (requirements.txt).
Infra and ops: top-level .env.example, docker-compose.yml (Milvus + MinIO + backend + frontend), slim Milvus-only compose (infra/milvus/milvus-docker-compose.yml), nginx sample (infra/nginx/nginx.conf), Milvus init helper (infra/scripts/init_milvus.py), and frontend dev Dockerfile (frontend/Dockerfile).
Rewrote README.md to document the new architecture, memory split (Memori vs Milvus), file tree, and quickstart commands (use uvicorn app.main:app --reload --app-dir backend).
Tests not run (new deps not installed in this environment).

Next steps: 1) swap Memori client stubs with the official SDK calls, 2) connect the Milvus client to a running cluster and adjust collection schema/dim to your embedding model, 3) wire real embeddings/LLM calls (or mock providers) and hook the frontend to /api/v1/chat.